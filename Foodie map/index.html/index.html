<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foodie Map</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    #map { height: 500px; border-radius: 10px; margin-bottom: 20px; }
  </style>
</head>
<body class="container">
  <h1 class="text-center mt-3">ğŸœ Foodie Map</h1>

  <!-- Khung báº£n Ä‘á»“ -->
  <div id="map"></div>

  <!-- Form thÃªm quÃ¡n Äƒn -->
  <h2 class="mt-4">â• ThÃªm quÃ¡n Äƒn má»›i</h2>
  <div class="mb-3">
    <label class="form-label">TÃªn quÃ¡n Äƒn:</label>
    <input type="text" id="placeName" class="form-control" placeholder="Nháº­p tÃªn quÃ¡n">
  </div>
  <div class="mb-3">
    <label class="form-label">Tá»a Ä‘á»™ (latitude, longitude):</label>
    <input type="text" id="placeCoords" class="form-control" placeholder="(CÃ³ thá»ƒ bá» trá»‘ng náº¿u click báº£n Ä‘á»“)">
  </div>
  <button class="btn btn-success mb-4" onclick="addPlace()">ThÃªm vÃ o báº£n Ä‘á»“ & vÃ²ng quay</button>

  <!-- Danh sÃ¡ch quÃ¡n -->
  <h2 class="mt-4">ğŸ“‹ Danh sÃ¡ch quÃ¡n Äƒn</h2>
  <ul id="placeList" class="list-group mb-4"></ul>

  <!-- VÃ²ng quay -->
  <h2 class="text-center mt-4">ğŸ¡ VÃ²ng quay chá»n mÃ³n</h2>
  <div class="d-flex justify-content-center">
    <canvas id="wheel" width="400" height="400"></canvas>
  </div>
  <div class="text-center mt-3">
    <button class="btn btn-primary" onclick="spinWheel()">Quay Ngay</button>
  </div>
  <p class="text-center mt-3" id="result"></p>

  <script>
    // ================== MAP ==================
    var map = L.map('map').setView([21.0285, 105.8542], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Danh sÃ¡ch quÃ¡n ban Ä‘áº§u
    var foodPlaces = [
      { name: "Phá»Ÿ BÃ¡t ÄÃ n", coords: [21.035, 105.85] },
      { name: "BÃºn Cháº£ HÃ ng MÃ nh", coords: [21.033, 105.847] },
      { name: "CÆ¡m Táº¥m SÃ i GÃ²n", coords: [21.03, 105.86] },
      { name: "Phá»Ÿ ThÃ¬n LÃ² ÄÃºc", coords: [21.015851, 105.860729] },
      { name: "XÃ´i Yáº¿n Nguyá»…n Há»¯u HuÃ¢n", coords: [21.033512, 105.853268] },
      { name: "ChÃ¨ Bá»‘n MÃ¹a HÃ ng CÃ¢n", coords: [21.034923, 105.850367] },
      { name: "CÃ  phÃª Giáº£ng (Egg Coffee)", coords: [21.033994, 105.849894] },
      { name: "BÃ¡nh MÃ¬ 25 HÃ ng CÃ¡", coords: [21.036381, 105.847680] },
      { name: "BÃºn Thang Cáº§u Gá»—", coords: [21.033228, 105.852267] },
      { name: "Kem TrÃ ng Tiá»n", coords: [21.024884, 105.856511] }
    ];

    // Váº½ marker ban Ä‘áº§u
    foodPlaces.forEach(p => {
      L.marker(p.coords).addTo(map).bindPopup(`<b>${p.name}</b>`);
    });

    // ================== VÃ’NG QUAY ==================
    const dishes = foodPlaces.map(p => p.name);
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const radius = canvas.width / 2;
    let currentAngle = 0;

    function drawWheel() {
      const sliceAngle = (2 * Math.PI) / dishes.length;
      for (let i = 0; i < dishes.length; i++) {
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius, i * sliceAngle, (i + 1) * sliceAngle);
        ctx.fillStyle = i % 2 === 0 ? "#f8b400" : "#ff6363";
        ctx.fill();
        ctx.save();

        ctx.translate(radius, radius);
        ctx.rotate(i * sliceAngle + sliceAngle / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#fff";
        ctx.font = "16px Arial";
        ctx.fillText(dishes[i], radius - 10, 5);
        ctx.restore();
      }
    }

    function refreshWheel() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawWheel();
    }

    drawWheel();

    function spinWheel() {
      const spinAngle = Math.random() * 360 + 720;
      const spinTime = 3000;
      const start = Date.now();

      function animate() {
        const now = Date.now();
        const elapsed = now - start;
        if (elapsed < spinTime) {
          const progress = elapsed / spinTime;
          currentAngle = (spinAngle * progress * Math.PI) / 180;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.save();
          ctx.translate(radius, radius);
          ctx.rotate(currentAngle);
          ctx.translate(-radius, -radius);
          drawWheel();
          ctx.restore();
          requestAnimationFrame(animate);
        } else {
          const finalAngle = (spinAngle * Math.PI) / 180;
          const sliceAngle = (2 * Math.PI) / dishes.length;
          const winningIndex = Math.floor(
            ((2 * Math.PI - (finalAngle % (2 * Math.PI))) / sliceAngle) % dishes.length
          );
          const chosen = dishes[winningIndex];
          document.getElementById("result").innerText = "ğŸ‘‰ HÃ´m nay báº¡n Äƒn: " + chosen;

          const place = foodPlaces.find(p => p.name === chosen);
          if (place) {
            map.setView(place.coords, 16);
            L.popup().setLatLng(place.coords).setContent(`<b>${place.name}</b>`).openOn(map);
          }
        }
      }
      animate();
    }

    // ================== HÃ€M THÃŠM QUÃN ==================
    let lastClickedCoords = null;

    function addPlace() {
      const name = document.getElementById("placeName").value.trim();
      let coordsText = document.getElementById("placeCoords").value.trim();

      if (!name) {
        alert("âš ï¸ Vui lÃ²ng nháº­p tÃªn quÃ¡n!");
        return;
      }

      let coords;
      if (coordsText) {
        coords = coordsText.split(",").map(c => parseFloat(c));
        if (coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
          alert("âš ï¸ Tá»a Ä‘á»™ khÃ´ng há»£p lá»‡!");
          return;
        }
      } else if (lastClickedCoords) {
        coords = lastClickedCoords;
      } else {
        alert("âš ï¸ Vui lÃ²ng nháº­p tá»a Ä‘á»™ hoáº·c click báº£n Ä‘á»“!");
        return;
      }

      const newPlace = { name: name, coords: coords };
      foodPlaces.push(newPlace);
      dishes.push(name);

      L.marker(coords).addTo(map).bindPopup(`<b>${name}</b>`);

      refreshWheel();
      updatePlaceList();
    }

    // ================== CLICK MAP ==================
    let tempMarker = null;

    map.on("click", function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      lastClickedCoords = [parseFloat(lat), parseFloat(lng)];
      document.getElementById("placeCoords").value = lat + ", " + lng;

      if (tempMarker) {
        map.removeLayer(tempMarker);
      }

      tempMarker = L.marker([lat, lng]).addTo(map)
        .bindPopup("ğŸ“ Vá»‹ trÃ­ báº¡n chá»n: " + lat + ", " + lng).openPopup();
    });

    // ================== DANH SÃCH QUÃN ==================
    function updatePlaceList() {
      const list = document.getElementById("placeList");
      list.innerHTML = "";
      foodPlaces.forEach((p, index) => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          ${p.name}
          <button class="btn btn-sm btn-danger">âŒ</button>
        `;
        li.querySelector("button").onclick = () => {
          foodPlaces.splice(index, 1);
          dishes.splice(index, 1);
          refreshWheel();
          updatePlaceList();
        };
        list.appendChild(li);
      });
    }

    updatePlaceList();
  </script>
</body>
</html>
